#!/bin/sh
# initramfs‑tools hook – copy UDP client binary and keyscript into the initramfs

PREREQ=""
prereqs() { echo "$PREREQ"; }
case "$1" in
    prereqs) prereqs; exit 0 ;;
esac

. /usr/share/initramfs-tools/hook-functions

# Copy the static client binary (built as /usr/local/sbin/udp-client) to /usr/bin inside initramfs
if [ -f "/usr/local/sbin/udp-client" ]; then
    copy_exec /usr/local/sbin/udp-client /usr/bin/udp-client
else
    echo "/usr/local/sbin/udp-client not found – please run the build script first" >&2
    exit 1
fi

# Copy the keyscript (generated by the interactive setup) to the location cryptsetup expects
if [ -f "/usr/lib/cryptsetup/scripts/udp_keyscript" ]; then
    copy_exec /usr/lib/cryptsetup/scripts/udp_keyscript /usr/lib/cryptsetup/scripts/udp_keyscript
else
    echo "udp_keyscript not found – please run the interactive setup first" >&2
    exit 1
fi

# Copy static secret into initramfs at /conf/conf.d/static_key
if [ -f "/etc/initramfs-tools/conf.d/static_key" ]; then
    . /etc/initramfs-tools/conf.d/static_key
    mkdir -p "${DESTDIR}/conf"
    printf "%s" "$STATIC_KEY" > "${DESTDIR}/conf/static_key"
    chmod 600 "${DESTDIR}/conf/static_key"
else
    echo "/etc/initramfs-tools/conf.d/static_key not found – static key will be missing" >&2
fi

exit 0
