#!/bin/sh
# initramfs‑tools hook – copy UDP client binary and keyscript into the initramfs

PREREQ=""
prereqs() { echo "$PREREQ"; }
case "$1" in
    prereqs) prereqs; exit 0 ;;
esac

. /usr/share/initramfs-tools/hook-functions

# Copy the static client binary (built as udp-client.musl) to /usr/bin inside initramfs
if [ -f "udp-client.musl" ]; then
    copy_exec "$(pwd)/udp-client.musl" /usr/bin/udp-client
else
    echo "udp-client.musl not found – please run the build script first" >&2
    exit 1
fi

# Copy the keyscript (generated by the interactive setup) to the location cryptsetup expects
if [ -f "udp_keyscript" ]; then
    copy_exec "$(pwd)/udp_keyscript" /usr/lib/cryptsetup/scripts/udp_keyscript
else
    echo "udp_keyscript not found – please run the interactive setup first" >&2
    exit 1
fi

exit 0
