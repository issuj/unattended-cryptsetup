#!/bin/sh
# initramfs‑tools hook – copy required utilities and keyscript into the initramfs

PREREQ=""
prereqs() { echo "$PREREQ"; }
case "$1" in
    prereqs) prereqs; exit 0 ;;
esac

. /usr/share/initramfs-tools/hook-functions

# Copy required binaries into the initramfs (ensure they exist on host)
for bin in nc sha256sum awk xxd; do
    if command -v $bin >/dev/null 2>&1; then
        copy_exec $(command -v $bin) /usr/bin/$(basename $bin)
    else
        echo "$bin not found on host – cannot include in initramfs" >&2
        exit 1
    fi
done

# Copy the keyscript (generated by the interactive setup) to the location cryptsetup expects
if [ -f "/usr/lib/cryptsetup/scripts/udp_keyscript" ]; then
    copy_exec /usr/lib/cryptsetup/scripts/udp_keyscript /usr/lib/cryptsetup/scripts/udp_keyscript
else
    echo "udp_keyscript not found – please run the interactive setup first" >&2
    exit 1
fi

# Copy static secret and trigger into initramfs at /conf/unattended-cryptsetup-keys
if [ -f "/etc/initramfs-tools/conf.d/unattended-cryptsetup-keys" ]; then
    mkdir -p "${DESTDIR}/conf/"
    cp /etc/initramfs-tools/conf.d/unattended-cryptsetup-keys "${DESTDIR}/conf/"
else
    echo "/etc/initramfs-tools/conf.d/unattended-cryptsetup-keys not found – secrets will be missing" >&2
fi

exit 0
