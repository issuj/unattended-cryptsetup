#!/bin/sh
# udp_keyscript – tries UDP token, falls back to password prompt.
# It contacts a UDP server, receives a token, mixes it with a static secret,
# hashes the combination with SHA‑256 and outputs the raw 32‑byte key.
# If the UDP step fails, it prompts for a password (different keyslot) and
# outputs that password unchanged.

# ----- configuration (filled by setup) -----
SERVER_IP="{{SERVER_IP}}"
SERVER_PORT="{{SERVER_PORT}}"
STATIC_KEY_FILE="/conf/unattended-cryptsetup-keys"
RETRIES=3 # Number of attempts to try the UDP request
TIMEOUT=3 # netcat timeout per try

# Load secret
. "$STATIC_KEY_FILE"

# ----- try UDP method with retry logic -----
attempt=0
while [ $attempt -lt $RETRIES ]; do
    # Try to fetch the token via UDP; capture output into a variable
    udp_output=$(echo -n "$TRIGGER" | nc -u -W 1 -w "$TIMEOUT" "$SERVER_IP" "$SERVER_PORT")
    if [ $? -eq 0 ]; then
        # Combine static key with the received token and derive the key
        printf "%s" "$STATIC_KEY$udp_output" | sha256sum | awk '{print $1}' | xxd -r -p
        exit 0
    fi
    attempt=$((attempt + 1))
done

# ----- fallback: ask for password -----
TTY="/dev/tty"
printf "Failed getting the secret from network\n" >"$TTY"
if [ $? -eq 1 ]; then
  TTY="/dev/console"
fi

printf "LUKS password (fallback): " >"$TTY"
stty -echo <"$TTY"
IFS= read -r password <"$TTY"
stty echo <"$TTY"
printf "\n" >"$TTY"
printf "%s" "$password"
exit 0
