#!/bin/sh
# udp_keyscript – tries UDP token, falls back to password prompt.
# It contacts a UDP server, receives a token, mixes it with a static secret,
# hashes the combination with SHA‑256 and outputs the raw 32‑byte key.
# If the UDP step fails, it prompts for a password (different keyslot) and
# outputs that password unchanged.

# ----- configuration (filled by setup) -----
SERVER_IP="{{SERVER_IP}}"
SERVER_PORT="{{SERVER_PORT}}"
STATIC_KEY_FILE="/conf/unattended-cryptsetup-keys"
RETRIES=3 # Number of attempts to try the UDP request
TIMEOUT=3 # netcat timeout per try

# Load secret
. "$STATIC_KEY_FILE"

# ----- try UDP method with retry logic -----
attempt=0
while [ $attempt -lt $RETRIES ]; do
    if echo -n "$TRIGGER" | nc -u -w "$TIMEOUT" "$SERVER_IP" "$SERVER_PORT" \
        | { printf "%s" "$STATIC_KEY"; cat; } \
        | sha256sum | awk '{print $1}' | xxd -r -p; then
        exit 0
    fi
    attempt=$((attempt + 1))
    done

# ----- fallback: ask for password -----
printf "LUKS password (fallback): " >/dev/tty
stty -echo </dev/tty
IFS= read -r password </dev/tty
stty echo </dev/tty
printf "\n" >/dev/tty
printf "%s" "$password"
exit 0
